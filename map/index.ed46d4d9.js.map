{"mappings":"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","sources":["src/map/main.js"],"sourcesContent":["\nvar reader = new FileReader();\nreader.onload = function (event) {\n    var bytes = event.target.result;\n    mapLoaded(bytes)\n};\n\nvar file = document.getElementById('file');\nfile.onchange = function (event) {\n    if (file.files.length > 0) {\n        document.getElementById('symbol').innerHTML = 'Loading map...'\n        reader.readAsText(file.files[0]);\n    }\n};\n\n\nfunction mapLoaded(data) {\n    let lines = data.split('\\n');\n\n    let index = 0\n    let line = lines[index]\n    while (!line.startsWith('rom')) {\n        index += 1\n        line = lines[index]\n    }\n    index += 1\n    line = lines[index]\n    while (!line.startsWith('rom')) {\n        index += 1\n        line = lines[index]\n    }\n    console.log(line)\n    index += 1\n    line = lines[index]\n    // Parse declarations\n    let current_file = 'UNKNOWN'\n\n    symbols = []\n    while (index < lines.length) {\n        if (line.includes('debug_aranges')) {\n            // Break at the start of potentiall debug info if built with -g\n            break;\n        } else if (line.startsWith(' .')) {\n            // ignore this definition of filename\n        } else if(line.startsWith('  ')) {\n            let arr = line.split(/\\W+/)\n            //console.log(arr)\n            if (arr.length == 3 && arr[2] != '') { // it is actually a symbol\n                //console.log(parseInt(arr[1],16), arr[2])\n                let addr = parseInt(arr[1], 16)\n                if (symbols.length > 0) {\n                    symbols[symbols.length-1].size = addr - symbols[symbols.length-1].addr\n                }\n                symbols.push(\n                    {\n                        addr: addr,\n                        name: arr[2],\n                        file: current_file,\n                        size: 0\n                    }\n                )\n            }\n        } else if (!line.startsWith(' *')) {\n            // this defines the name\n            current_file = line.split('(')[0].trim()\n            //console.log(current_file)\n        }\n        index += 1\n        line = lines[index]\n    }\n    console.log(symbols)\n\n    redrawCanvas();\n\n}\n\nlet offset = 0x8000000\nlet symbols = []\n\nlet canvasWidth = 1024, canvasHeight = 1024;\nlet mode = 0;\n\nfunction redrawCanvas() {\n    hoverOverSymbols = false\n    document.getElementById('symbol').innerHTML = 'Painting map...'\n    setTimeout(() => {\n        drawCanvas();\n    }, 10);\n}\n\nlet typeRegexes = {\n    // audio\n    '^data/sound/.*': 24,\n    // graphics\n    'data/gfx/sprite_gfx.o': 5, // TODO not correctly split up into sprites yet\n    '^data/gfx/.*': 6,\n    //'data/data_08132B30.o': 7, // TODO maybe not everything in this file is graphics/maps\n\n    // maps/tilesets\n    '^data/map/.*': 20,\n\n    // code\n    'data/strings.o': 5,\n    'data/scripts.o': 4,\n    // data\n    '^data/animations/.*': 15,\n    '^data/const/.*': 14,\n\n    '^asm/.*': 13,\n    '^data/.*': 16,\n    '^src/.*': 3,\n}\n\n//  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24\n//           x  x  x        x             x  x  x  x           x           x\n// TODO add legend\n\nlet  colors = [\n    '#daf5b1',\n    '#a4ed8b',\n    '#6ce67f',\n    '#3fcc94',\n    '#2bada2',\n    '#22768f',\n    '#183c7a',\n    '#291e58',\n    '#3b0137',\n    '#660653',\n    '#940f5a',\n    '#a6174c',\n    '#cc293f',\n    '#eb3636',\n    '#eb6746',\n    '#f5a762',\n    '#fcd87e',\n    '#fffa9e',\n    '#fffbc7',\n    '#fcfffd',\n    '#d6fcff',\n    '#b7d9f7',\n    '#95a4f0',\n    '#8775eb',\n    '#7e4ae0',\n]\n\nfunction hexToRgb(hex) {\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n    return result ? {\n    r: parseInt(result[1], 16),\n    g: parseInt(result[2], 16),\n    b: parseInt(result[3], 16)\n    } : null;\n}\n\n\nfunction drawPalette() {\n    let parent = document.createElement('div')\n    let index = 0\n    for(let color of colors) {\n        let div = document.createElement('div')\n        div.style.background = color\n        div.style.width = '32px'\n        div.style.height = '32px'\n        div.style.display = 'inline-block'\n        div.id = 'color_' + index\n        div.innerHTML = ''+index\n        div.style.textAlign = 'center'\n        div.style.verticalAlign = 'center'\n        div.style.lineHeight = '32px'\n        div.style.color = '#000'\n        index++;\n        parent.appendChild(div)\n    }\n    document.body.appendChild(parent)\n\n}\ndrawPalette();\nfor (let i = 0; i < colors.length; i++) {\n    colors[i] = hexToRgb(colors[i])\n}\n\nfunction drawCanvas() {\n    if (symbols.length == 0) {\n        document.getElementById('symbol').innerHTML = ''\n        return;\n    }\n    document.getElementById('offset').innerHTML = 'Offset: ' + offset.toString(16)\n    // TODO color by symbol or by file\n\n    let current_color = colors[0]\n    let color_index = 0\n    let canvas = document.getElementById('pixels')\n    var ctx = canvas.getContext('2d');\n\n\n    let last_used_addr = symbols[symbols.length-1].addr\n    canvasHeight = (last_used_addr - 0x8000000) / 1024 + 1\n    canvas.height = canvasHeight\n\n    var canvasData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);\n\n    let next_symbol = 0\n    while (next_symbol < symbols.length && symbols[next_symbol].addr < offset) { // TODO handle EOF\n        next_symbol++;\n    }\n\n    if (next_symbol == symbols.length) {\n        ctx.clearRect(0,0,canvasWidth,canvasHeight);\n        console.error('End of usable symbols')\n        return\n    }\n\n    let colorByFile = false;\n    let lastFile = symbols[0].file;\n    let lastFolder = ''\n\n\n    for (let i = 0; i < canvasWidth*canvasHeight; i++) {\n        if (next_symbol < symbols.length && offset + i >= symbols[next_symbol].addr) {\n\n            switch (mode) {\n                case 0: // symbol\n                    color_index = (color_index + 1) % colors.length\n                    current_color = colors[color_index]\n                    break;\n                case 1: // file\n                    if (lastFile != symbols[next_symbol].file) {\n                        color_index = (color_index + 1) % colors.length\n                        current_color = colors[color_index]\n                        lastFile = symbols[next_symbol].file\n                    }\n                    break;\n                case 2: // folder\n                    if (lastFile != symbols[next_symbol].file) {\n                        lastFile = symbols[next_symbol].file\n                        let folder = lastFile.substring(0,lastFile.lastIndexOf('/'))\n                        if (folder != lastFolder) {\n                            color_index = (color_index + 1) % colors.length\n                            current_color = colors[color_index]\n                            lastFolder = folder\n                        }\n                    }\n                    break;\n                case 3: // type\n                    if (lastFile != symbols[next_symbol].file) {\n                        lastFile = symbols[next_symbol].file\n                        let found = false\n                        for (let key of Object.keys(typeRegexes)) {\n                            //let regex = new RegExp(key)\n                            if (lastFile.match(key)) {\n                                found = true\n                                current_color = colors[typeRegexes[key]]\n                                break\n                            }\n                        }\n                        if (!found) {\n                            current_color = '#ff00ff'\n                        }\n                    }\n                    break;\n            }\n            next_symbol++;\n            if (next_symbol == symbols.length) {\n                current_color = '#000000'\n            }\n        }\n        let rgb = current_color\n        canvasData.data[i*4 + 0] = rgb.r;\n        canvasData.data[i*4 + 1] = rgb.g;\n        canvasData.data[i*4 + 2] = rgb.b;\n        canvasData.data[i*4 + 3] = 255;\n    }\n    ctx.putImageData(canvasData, 0, 0);\n    console.log((offset + canvasWidth*canvasHeight).toString(16))\n    /*\n\n    for (let i = 0; i < 1024*1024; i++) {\n    //for (let i = 0x8000000; i < last_used_addr; i++) {\n        let pixel = document.createElement('div');\n        pixel.className = 'pixel';\n        pixel.style.background = colors[current_color]\n        current_color = (current_color + 1) % colors.length\n        parent.appendChild(pixel);\n    }*/\n    document.getElementById('symbol').innerHTML = 'Done'\n    hoverOverSymbols = true;\n}\n//console.log('loaded')\n\nfunction changeOffset(diff) {\n    offset += diff\n    drawCanvas(offset, symbols)\n}\n\nlet hoverOverSymbols = false;\n\nfunction mouseMove(event) {\n    if (!hoverOverSymbols) {\n        return;\n    }\n    let rect = event.target.getBoundingClientRect();\n    let x = event.clientX - rect.left;\n    let y = event.clientY - rect.top;\n    let addr = offset + x + y * canvasWidth;\n    let next_symbol = 0\n    while (next_symbol < symbols.length && symbols[next_symbol].addr < addr) { // TODO handle EOF\n        next_symbol++;\n    }\n    if (next_symbol == symbols.length) {\n        document.getElementById('symbol').innerHTML = 'No symbol'\n        return\n    }\n    let symbol = symbols[next_symbol-1]\n    document.getElementById('symbol').innerHTML = '0x'+addr.toString(16) + ' ' + symbol.name + ' ' + symbol.file + ' (+'+(addr-symbol.addr)+'|' + symbol.size + ')'\n}\n\nfunction toggleChanging() {\n    hoverOverSymbols = !hoverOverSymbols;\n}\n\nfunction changeMode(newMode) {\n    document.getElementById('mode'+mode).classList.remove('active')\n    mode = newMode;\n    document.getElementById('mode'+mode).classList.add('active')\n    if (symbols.length > 0) {\n        redrawCanvas();\n    }\n}\n\n// document.getElementById('next').onclick = () => changeOffset(canvasWidth*canvasHeight)\n// document.getElementById('prev').onclick = () => changeOffset(-canvasWidth*canvasHeight)\ndocument.getElementById('mode0').onclick = () => changeMode(0)\ndocument.getElementById('mode1').onclick = () => changeMode(1)\ndocument.getElementById('mode2').onclick = () => changeMode(2)\ndocument.getElementById('mode3').onclick = () => changeMode(3)\ndocument.getElementById('pixels').onmousemove = mouseMove;\ndocument.getElementById('pixels').onclick = toggleChanging;"],"names":["$fd20e1b766853d4e$var$reader","FileReader","onload","event","data","lines","split","index","line","startsWith","console","log","current_file","$fd20e1b766853d4e$var$symbols","length","includes","arr","addr","parseInt","size","push","name","file","trim","$fd20e1b766853d4e$var$redrawCanvas","$fd20e1b766853d4e$var$mapLoaded","target","result","$fd20e1b766853d4e$var$file","document","getElementById","onchange","files","innerHTML","readAsText","$fd20e1b766853d4e$var$offset","$fd20e1b766853d4e$var$canvasHeight","$fd20e1b766853d4e$var$mode","$fd20e1b766853d4e$var$hoverOverSymbols","setTimeout","$fd20e1b766853d4e$var$drawCanvas","$fd20e1b766853d4e$var$typeRegexes","$fd20e1b766853d4e$var$colors","parent","createElement","color","div","style","background","width","height","display","id","textAlign","verticalAlign","lineHeight","appendChild","body","$fd20e1b766853d4e$var$drawPalette","i","hex","exec","r","g","b","toString","current_color","color_index","canvas","ctx","getContext","last_used_addr","canvasData","getImageData","next_symbol","clearRect","error","lastFile","lastFolder","i1","folder","substring","lastIndexOf","found","key","Object","keys","match","rgb","putImageData","$fd20e1b766853d4e$var$changeMode","newMode","classList","remove","add","onclick","onmousemove","rect","getBoundingClientRect","x","clientX","left","y","clientY","top","symbol"],"version":3,"file":"index.ed46d4d9.js.map"}